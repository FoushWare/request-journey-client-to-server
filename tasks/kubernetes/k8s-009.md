# Task: Kubernetes Cluster Upgrades & Maintenance
**Issue:** #130 | **Category:** Kubernetes | **Priority:** High | **Effort:** 7h

---

## üìã Objective

Plan and execute Kubernetes cluster upgrades with zero downtime and maintain cluster health.

---

## üìù Description

Manage cluster lifecycle including upgrades, patches, and maintenance:
- Plan upgrade strategy
- Cordon and drain nodes
- Monitor upgrade process
- Rollback procedures
- Health verification
- Documentation updates

---

## ‚úÖ Acceptance Criteria

- [ ] Upgrade strategy documented
- [ ] Pre-upgrade checklist created
- [ ] Upgrade procedure tested
- [ ] Rollback procedure tested
- [ ] Post-upgrade verification complete
- [ ] Health checks pass
- [ ] Performance baselines maintained
- [ ] Team trained on upgrade process
- [ ] Runbooks created
- [ ] Communication plan defined

---

## üîß Sub-Tasks

### 1. Upgrade Planning & Preparation
- [ ] Assess current cluster version
- [ ] Identify compatible upgrade paths
- [ ] Review upgrade release notes
- [ ] Plan maintenance window
- [ ] Notify stakeholders
- [ ] Prepare rollback plan

### 2. Pre-upgrade Health Checks
- [ ] Verify cluster health
- [ ] Check resource availability
- [ ] Monitor metric baselines
- [ ] Test critical applications
- [ ] Backup etcd
- [ ] Document baseline state

### 3. Control Plane Upgrade
- [ ] Update kubernetes version
- [ ] Upgrade API server
- [ ] Upgrade controller-manager
- [ ] Upgrade scheduler
- [ ] Verify component health
- [ ] Monitor system metrics

### 4. Node Upgrade Strategy
- [ ] Plan node drain order
- [ ] Set pod disruption budgets
- [ ] Test upgrade on single node first
- [ ] Cordon nodes before upgrade
- [ ] Drain pods gracefully
- [ ] Verify pod rescheduling

### 5. Worker Node Upgrades
- [ ] Upgrade kubelet on nodes
- [ ] Upgrade kube-proxy
- [ ] Update node OS if needed
- [ ] Verify node readiness
- [ ] Monitor pod rescheduling
- [ ] Uncordon nodes

### 6. CNI & Addon Upgrades
- [ ] Upgrade network plugin (Calico/Cilium)
- [ ] Upgrade DNS (CoreDNS)
- [ ] Upgrade ingress controller
- [ ] Upgrade storage plugins
- [ ] Verify addon health
- [ ] Test network connectivity

### 7. Data Integrity Verification
- [ ] Verify etcd health
- [ ] Check persistent volume status
- [ ] Validate database integrity
- [ ] Test backup restoration
- [ ] Verify data consistency
- [ ] Document findings

### 8. Application Testing Post-Upgrade
- [ ] Run smoke tests
- [ ] Verify service health
- [ ] Test critical user journeys
- [ ] Monitor error rates
- [ ] Check performance metrics
- [ ] Document results

### 9. Monitoring & Observation
- [ ] Monitor cluster metrics during upgrade
- [ ] Track resource utilization
- [ ] Watch for error spikes
- [ ] Monitor pod failures
- [ ] Log all upgrade steps
- [ ] Collect upgrade statistics

### 10. Post-Upgrade Documentation
- [ ] Document upgrade steps taken
- [ ] Update version tracking
- [ ] Update cluster documentation
- [ ] Create lessons learned report
- [ ] Update runbooks
- [ ] Schedule knowledge sharing

---

## üìö Learning Resources

- **Kubernetes Upgrade:** https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/
- **Node Drain:** https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-a-node/
- **Pod Disruption Budgets:** https://kubernetes.io/docs/tasks/run-application/configure-pdb/
- **Cluster Backup:** https://etcd.io/docs/current/op-guide/recovery/
- **Version Skew:** https://kubernetes.io/releases/version-skew-policy/

---

## üíª Code Example: Pre-upgrade Checklist

```bash
#!/bin/bash
# Pre-upgrade health check script

echo "=== Kubernetes Upgrade Pre-check ==="
echo ""

# Check cluster version
echo "Current Kubernetes Version:"
kubectl version --short

# Check node status
echo -e "\n=== Node Status ==="
kubectl get nodes -o wide

# Check component health
echo -e "\n=== Component Status ==="
kubectl get componentstatuses

# Check pod disruption budgets
echo -e "\n=== Pod Disruption Budgets ==="
kubectl get poddisruptionbudgets -A

# Check resource requests/limits
echo -e "\n=== Resource Requests/Limits ==="
kubectl describe nodes | grep -A 5 "Allocated resources"

# Check persistent volumes
echo -e "\n=== Persistent Volumes Status ==="
kubectl get pv -o wide
kubectl get pvc -A

# Check etcd health (if accessible)
echo -e "\n=== etcd Cluster Status ==="
kubectl get endpoints etcd -n kube-system -o yaml

# Check DNS
echo -e "\n=== DNS Health ==="
kubectl run -it --rm debug --image=busybox:1.28 --restart=Never -- nslookup kubernetes.default

# Check all pods running
echo -e "\n=== Pod Status ==="
kubectl get pods -A --field-selector=status.phase!=Running

# Check for recent events
echo -e "\n=== Recent Events ==="
kubectl get events -A --sort-by='.lastTimestamp' | tail -20

# Take etcd backup
echo -e "\n=== Creating etcd Backup ==="
BACKUP_DIR="/tmp/etcd-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"
echo "Backup would be saved to: $BACKUP_DIR"

echo -e "\n=== Pre-check Complete ==="
```

---

## üîÑ Node Upgrade Procedure

```bash
#!/bin/bash
# Safe node upgrade procedure

NODE=$1
CLUSTER=$2

echo "Preparing to upgrade node: $NODE"

# Step 1: Cordon the node (prevent new pods)
echo "Step 1: Cordoning node..."
kubectl cordon $NODE

# Step 2: Drain the node (evict existing pods)
echo "Step 2: Draining node..."
kubectl drain $NODE \
  --ignore-daemonsets \
  --delete-emptydir-data \
  --force \
  --grace-period=300 \
  --timeout=5m

# Step 3: Verify pods are evicted
echo "Step 3: Verifying pod eviction..."
kubectl get pods --field-selector=spec.nodeName=$NODE

# Step 4: Upgrade node (OS-specific)
echo "Step 4: Upgrading node..."
# For AWS EC2: update AMI and relaunch
# For kubeadm: kubeadm upgrade node

# Step 5: Verify node health
echo "Step 5: Verifying node health..."
kubectl get node $NODE -o wide
kubectl describe node $NODE

# Step 6: Uncordon the node
echo "Step 6: Uncordoning node..."
kubectl uncordon $NODE

# Step 7: Verify pod rescheduling
echo "Step 7: Monitoring pod rescheduling..."
watch 'kubectl get pods --field-selector=spec.nodeName=$NODE'

echo "Node upgrade complete!"
```

---

## üìä Upgrade Progress Monitoring

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: upgrade-status
  namespace: kube-system
data:
  status: |
    Cluster Upgrade Status:
    - Control Plane: 1.28.0 ‚Üí 1.28.2 (in-progress)
    - Node 1: 1.28.0 ‚Üí 1.28.2 (pending)
    - Node 2: 1.28.0 ‚Üí 1.28.2 (pending)
    - Node 3: 1.28.0 (stable)
    
    Timeline:
    - Start: 2024-01-15 02:00 UTC
    - API Server: ‚úì Complete
    - Controller Manager: ‚úì Complete
    - Scheduler: ‚úì Complete
    - Node 1: ‚è≥ In Progress
    - Node 2: ‚è≥ Waiting
    - Node 3: ‚è≥ Waiting
    
    Rollback Available: Yes
    Estimated Completion: 03:45 UTC
```

---

## üîí Security Considerations

- **Network Isolation:** Restrict upgrade traffic
- **RBAC:** Control who can perform upgrades
- **Audit Logging:** Log all upgrade operations
- **Backup Verification:** Ensure backups are valid
- **Rollback Testing:** Regularly test rollback
- **Communication:** Notify security team of upgrades

---

## ‚ú® Success Metrics

- Zero downtime during upgrades
- All nodes successfully upgraded
- Pod rescheduling < 2 minutes per node
- Post-upgrade error rate < baseline
- Rollback not needed
- Team confidence in upgrade process

---

## üìñ Related Tasks

- [K8s Deployment](k8s-002.md) - Application deployment
- [Monitoring](k8s-008.md) - Health checks
- [Backup Strategy](k8s-009.md) - Data recovery

---

**Created:** January 17, 2026 | **Last Updated:** January 17, 2026
